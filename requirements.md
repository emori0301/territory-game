# 陣地トリゲーム 要件定義書

## 1. プロジェクト概要

### 1.1 ゲームコンセプト
30×30グリッド上で自律移動するコマ（雄・雌）が領地を塗り、合体・繁殖・均等化を行い、劣勢時に英雄が誕生し、最終的に一勢力が勝利する観察型シミュレーションゲーム。

### 1.2 ゲームタイプ
- **観察型シミュレーション**：プレイヤー操作なし、自動進行のみ
- **ターンベース**：tick単位で進行
- **同時解決方式**：全コマが同時に行動

### 1.3 MVPのゴール
- 同時移動が正しく機能する
- 英雄による逆転が発生する
- 巨大化と崩壊の波が観察できる
- 処理が安定して停止しない

---

## 2. 技術スタック

### 2.1 フロントエンド
- **Next.js**（App Router）
- **TypeScript**
- **shadcn/ui**
- **Canvas描画**（盤面・コマ・領地の可視化）

### 2.2 バックエンド
- **tRPC**（型安全なAPI通信）
- **Node.js**
- **Prisma ORM**（データベース操作）

### 2.3 データベース
- **PostgreSQL**

### 2.4 インフラ
- **Docker**
- **docker-compose**

---

## 3. ゲーム仕様

### 3.1 盤面仕様

#### 3.1.1 サイズ
- **30 × 30 固定**（900マス）

#### 3.1.2 マス構造
```typescript
{
  x: number          // 0-29
  y: number          // 0-29
  ownerFactionId: string | null  // 領地の所有者勢力ID
  unitId: string | null          // そのマスにいるコマID
}
```

#### 3.1.3 制約
- **1マス1コマ**：同一マスに複数コマは存在不可
- **死亡しても領地は維持**：コマが死亡しても領地は残る
- **初期状態は全マス無色**：ownerFactionId = null

---

### 3.2 勢力仕様

#### 3.2.1 基本設定
- **勢力数**：2勢力
- **初期コマ数**：各勢力10体
- **初期value**：各コマ10
- **性別**：50%ランダム（male/female）

#### 3.2.2 初期配置
- **勢力A**：左上エリア（0-14, 0-14）にランダム配置
- **勢力B**：右下エリア（15-29, 15-29）にランダム配置

---

### 3.3 コマ仕様

#### 3.3.1 データ構造
```typescript
{
  id: string                    // ユニークID
  factionId: string            // 所属勢力ID
  x: number                     // X座標（0-29）
  y: number                     // Y座標（0-29）
  sex: "male" | "female"       // 性別
  value: number                 // 寿命兼強さ
  isHero: boolean               // 英雄フラグ
  age: number                   // 経過tick数
}
```

#### 3.3.2 パラメータ説明
- **value**：寿命兼強さ（0以下で死亡、戦闘時の強さ）
- **age**：経過tick数（100以上で死亡）
- **isHero**：英雄フラグ（特殊能力を持つ）

---

### 3.4 Tick仕様（同時解決方式）

#### 3.4.1 基本原則
- **1tickで全コマが同時に移動**
- **順番処理は禁止**
- **移動意図を集計してから解決**

#### 3.4.2 1tickの処理フロー
1. **移動方向決定フェーズ**
   - 全コマが移動方向を決定（まだ移動しない）
   - 移動予定マップを作成

2. **衝突解決フェーズ**
   - 同一マスへの衝突を検出
   - 衝突ルールに従って解決

3. **移動確定フェーズ**
   - 衝突解決後の移動を確定

4. **領地塗り処理**
   - 移動先マスの領地状態に応じて処理

5. **value消費処理**
   - 領地塗りによるvalue消費

6. **自然減衰処理**
   - value > 10のコマは-1

7. **英雄誕生判定**
   - 条件を満たす場合、英雄を生成

8. **死亡処理**
   - 死亡条件を満たすコマを削除

---

### 3.5 移動ルール

#### 3.5.1 基本移動
- **方向**：上下左右ランダム選択
- **盤外移動**：無効（その場に留まる）
- **移動先が自勢力領地**：value消費なし
- **移動先が他勢力 or 無色**：value -1 して塗る

---

### 3.6 衝突ルール

#### 3.6.1 同勢力衝突

**雄 × 雄**
- value合算
- 1体に統合（性別はmale）
- もう一方削除
- value > 10の場合、自然減衰対象

**雄 × 雌（繁殖）**
- 子供を隣接空マスに生成
- 子供value = floor((親1 + 親2) / 2)
- 子供sexランダム
- 親それぞれ value -2
- **空マスがない場合は不発**（何も起こらない）

**雌 × 雌**
- total = a.value + b.value
- a.value = floor(total / 2)
- b.value = ceil(total / 2)
- 両方とも生存

#### 3.6.2 敵勢力衝突

**戦闘処理**
- 勝率 = 自分value / (自分value + 相手value)
- ランダム判定で勝者決定
- **勝者**：そのマスを占有、value +2
- **敗者**：削除

---

### 3.7 自然減衰

#### 3.7.1 条件
- **value > 10** のコマは毎tick -1
- **英雄は減衰なし**

---

### 3.8 英雄システム

#### 3.8.1 誕生条件
以下の条件を**全て**満たす場合、10%確率でランダム1体を英雄化：
- 勢力コマ数が全体の20%未満
- 既に英雄が存在しない（その勢力内）

#### 3.8.2 英雄能力
- **移動時**：上下左右も自勢力に塗る
- **敵撃破時**：value完全吸収（相手のvalueを全て獲得）
- **自然減衰なし**
- **age >= 50 で死亡**（通常コマより短命）

#### 3.8.3 英雄死亡時
- 周囲1マス（上下左右）を無色化

---

### 3.9 死亡条件

以下のいずれかを満たすと死亡：
- **value <= 0**
- **age >= 100**（英雄は50）
- **戦闘敗北**

---

### 3.10 勝利条件

以下のいずれかを満たすとゲーム終了：
- **片勢力のコマ数が0**
- **500tick経過時にコマ数が多い勢力勝利**（同数の場合は引き分け）

---

## 4. 非機能要件

### 4.1 パフォーマンス
- **最大コマ数**：300想定
- **tick処理**：100ms以内
- **同tick内の二重移動禁止**

### 4.2 処理の整合性
- **衝突解決は決定論的に処理**
- **同時移動の整合性保証**

### 4.3 データ整合性
- **1マス1コマの制約維持**
- **領地状態の正確な管理**

---

## 5. インフラ構成

### 5.1 Docker構成

#### 5.1.1 Services
- **web**：Next.jsアプリケーション
- **db**：PostgreSQLデータベース

#### 5.1.2 必要ファイル
- **Dockerfile**（Next.js用）
- **docker-compose.yml**
- **Prisma migration対応**
- **環境変数でDATABASE_URL管理**

---

## 6. 実装優先順位

### Phase 1: 基本システム
1. 盤面・コマのデータ構造実装
2. 基本的な移動処理
3. 領地塗り処理
4. Canvas描画

### Phase 2: 衝突システム
1. 同勢力衝突（雄×雄、雄×雌、雌×雌）
2. 敵勢力衝突
3. 衝突解決の整合性保証

### Phase 3: 特殊システム
1. 自然減衰
2. 英雄システム
3. 死亡処理

### Phase 4: ゲームループ
1. Tick処理の完全実装
2. 勝利条件判定
3. ゲーム終了処理

### Phase 5: 最適化・安定化
1. パフォーマンス最適化
2. エラーハンドリング
3. バグ修正

---

## 7. 技術的考慮事項

### 7.1 同時移動の実装
- 移動意図を全コマから収集
- 衝突マップを作成
- 衝突解決アルゴリズムを適用
- 最終的な移動を確定

### 7.2 衝突解決の優先順位
1. 敵勢力衝突（最優先）
2. 同勢力衝突（雄×雄、雄×雌、雌×雌）
3. 移動確定

### 7.3 データベース設計
- ゲーム状態の永続化
- Tick履歴の保存（リプレイ機能用）
- パフォーマンス考慮（インデックス設計）

---

## 8. 今後の拡張案（MVP外）

- リプレイ機能
- 統計情報の可視化
- 複数ゲームの並行実行
- WebSocketによるリアルタイム観察
- ゲーム設定のカスタマイズ（盤面サイズ、初期コマ数など）

